<div>
  <app-breadcrumb-nav-bar
    [title]="'EMPLOYEES.DETAILS' | translate"
    [buttonType]="canEditEmployee ? ButtonType.EDIT : ButtonType.NONE"
    (onButtonClick)="editEmployee()">
  </app-breadcrumb-nav-bar>
  <div *ngIf="employee" class="general-info-row flex-row">
    <div class="payment-button-wrapper">
      <a *ngIf="canViewPaymentDetails" mat-icon-button [routerLink]="['../payments']" class="payment-button">
        <mat-icon class="payment-icon">attach_money</mat-icon>
      </a>
    </div>
    <div class="general-info flex-column">
      <h3 class="mid-pink">{{ employee.firstName + ' ' + employee.lastName }}</h3>
      <h4 *ngIf="employee.employeeId != null" class="primary-pink">{{ employee.employeeId.toString().padStart(6, '0') }}</h4>
      <h4 *ngIf="employee.phoneNumber" class="light-blue">{{ employee.phoneNumber }}</h4>
    </div>
    <div class="general-info-spacer"></div>
  </div>

  <div *ngIf="employee && (employee.role === Role.INSTRUCTOR || canEditEmployee)" class="flex-column employee-details-content">
    <!-- Teaching (instructors only) -->
    <ng-container *ngIf="employee.role === Role.INSTRUCTOR">
      <div class="flex-row classes-section">
        <h2 class="light-blue">{{ 'EMPLOYEES.TEACHING' | translate }}</h2>
        <button
          *ngIf="userService.isAdmin"
          mat-icon-button
          (click)="setShowAssignmentModal()"
          class="add-assign-button">
          <mat-icon class="add-icon" matPrefix>add</mat-icon>
        </button>
      </div>

      <div *ngFor="let assignmentGroup of assignmentsGrouped | keyvalue">
        <h3 class="mid-green">{{ 'CLASS_TYPES.' + assignmentGroup.key | translate | capitalize }}</h3>
        <hr />
        <div *ngFor="let locationGroup of assignmentGroup.value | keyvalue">
          <h4>{{ locationGroup.key }}</h4>
          <ul>
            <li *ngFor="let classAndAssignment of locationGroup.value">
              <div class="flex-row details-row">
                <a [routerLink]="['/admin/mobile/classes', classAndAssignment?.class?._id, 'details']">
                  {{ classAndAssignment.class.days | weekdays:'/' }} - {{ classAndAssignment.class.startTime | timeFormat }}
                </a>
                <div class="action-buttons">
                  <button
                    *ngIf="userService.isAdmin && (!classAndAssignment.assignment.status || classAndAssignment.assignment.status === AssignmentStatus.ACTIVE)"
                    mat-icon-button
                    class="unenroll-button"
                    type="button"
                    (click)="setShowUnassignModal(classAndAssignment)">
                    <mat-icon class="icon">person_remove</mat-icon>
                  </button>
                </div>
              </div>
            </li>
          </ul>
        </div>
      </div>

      <div *ngIf="activeAssignmentInfo.length === 0">
        <p class="not-teaching">{{ 'EMPLOYEES.NOT_TEACHING' | translate }}</p>
      </div>

      <!-- Past Assignments (status UNASSIGNED; use status only, not endDate) -->
      <div *ngIf="pastAssignmentInfo.length > 0" class="past-section">
        <h3 class="past-header">{{ 'EMPLOYEES.PAST_ASSIGNMENTS' | translate }}</h3>
        <hr />
        <div *ngFor="let assignmentGroup of pastAssignmentsGrouped | keyvalue">
          <h3 class="mid-green">{{ 'CLASS_TYPES.' + assignmentGroup.key | translate | capitalize }}</h3>
          <div *ngFor="let locationGroup of assignmentGroup.value | keyvalue">
            <h4>{{ locationGroup.key }}</h4>
            <ul>
              <li *ngFor="let classAndAssignment of locationGroup.value">
                <div class="flex-row details-row">
                  <a [routerLink]="['/admin/mobile/classes', classAndAssignment?.class?._id, 'details']">
                    {{ classAndAssignment.class.days | weekdays:'/' }} - {{ classAndAssignment.class.startTime | timeFormat }}
                  </a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Terminated Classes (class ended only; unassigned go to Past) -->
      <div *ngIf="terminatedAssignmentInfo.length > 0" class="terminated-section">
        <h3 class="terminated-header">{{ 'CLASSES.TERMINATED_CLASSES' | translate }}</h3>
        <hr />
        <div *ngFor="let assignmentGroup of terminatedAssignmentsGrouped | keyvalue">
          <h3 class="mid-green">{{ 'CLASS_TYPES.' + assignmentGroup.key | translate | capitalize }}</h3>
          <div *ngFor="let locationGroup of assignmentGroup.value | keyvalue">
            <h4>{{ locationGroup.key }}</h4>
            <ul>
              <li *ngFor="let classAndAssignment of locationGroup.value">
                <div class="flex-row details-row">
                  <a [routerLink]="['/admin/mobile/classes', classAndAssignment?.class?._id, 'details']">
                    {{ classAndAssignment.class.days | weekdays:'/' }} - {{ classAndAssignment.class.startTime | timeFormat }}
                  </a>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Notes (admin only) -->
    <div *ngIf="canEditEmployee">
      <app-notes
        [resourceType]="'employee'"
        [resourceId]="employeeId || ''"
        [notes]="employee.notes"
        (notesUpdated)="onNotesUpdated($event)">
      </app-notes>
    </div>
  </div>
</div>

<app-modal
  *ngIf="showAssignmentModal"
  [parent]="this"
  [title]="'EMPLOYEES.ASSIGN_INSTRUCTOR' | translate"
  [buttonList]="assignmentButtons"
  (modalClick)="processAssignmentModalClick($event)"
  class="assignment-modal">
  <div content>
    <p>{{ 'EMPLOYEES.ASSIGN_INSTRUCTIONS' | translate }}</p>
    <h5>{{ employee?.firstName }} {{ employee?.lastName }}</h5>
    <div [formGroup]="classSelectionForm">
      <app-dropdown
        *ngIf="classTypeOptions.length"
        label="CONTROLS.CLASS_TYPE"
        [options]="classTypeOptions"
        [i18nPrefix]="'CLASS_TYPES'"
        controlName="class_type">
      </app-dropdown>
      <app-dropdown
        label="CONTROLS.LOCATION"
        [options]="classLocationOptions"
        controlName="location"
        [disabled]="!selectedType">
      </app-dropdown>
      <app-dropdown
        label="CONTROLS.TIME"
        [options]="classTimesOptions"
        controlName="time"
        [disabled]="!selectedType || !selectedLocation">
      </app-dropdown>
      <app-datepicker
        label="CONTROLS.START_DATE"
        controlName="start_date"
        [allowedWeekdays]="selectedClassDays">
      </app-datepicker>
    </div>
  </div>
</app-modal>

<app-modal
  *ngIf="showUnassignModal"
  [parent]="this"
  [title]="'EMPLOYEES.UNASSIGN' | translate"
  [buttonList]="unassignButtons"
  (modalClick)="processUnassignModalClick($event)"
  class="unenroll-modal">
  <div content>
    <p>{{ 'EMPLOYEES.UNASSIGN_CONFIRM_MESSAGE' | translate }}</p>
    <div *ngIf="selectedAssignmentForUnassign">
      <h5>
        {{ 'CLASS_TYPES.' + selectedAssignmentForUnassign.class.classType | translate | capitalize }} -
        {{ selectedAssignmentForUnassign.class.classLocation }}
      </h5>
      <h5>
        {{ selectedAssignmentForUnassign.class.days | weekdays:'/' }} -
        {{ selectedAssignmentForUnassign.class.startTime | timeFormat }}
      </h5>
    </div>
    <div [formGroup]="unassignForm">
      <app-datepicker
        label="CONTROLS.END_DATE"
        controlName="end_date"
        [allowedWeekdays]="selectedAssignmentForUnassign?.class?.days ?? null"
        [minDate]="unassignMinDate">
      </app-datepicker>
    </div>
  </div>
</app-modal>
