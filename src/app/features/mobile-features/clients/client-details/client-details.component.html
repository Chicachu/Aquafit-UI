<div>
  <app-breadcrumb-nav-bar 
    [title]="'CLIENTS.DETAILS'" 
    [buttonType]="canEditClient ? ButtonType.EDIT : ButtonType.NONE"
    (onButtonClick)="editClient()">
  </app-breadcrumb-nav-bar>
  <div *ngIf="client" class="flex-column general-info">
    <h3 class="mid-pink">{{ client.firstName + ' ' + client.lastName }}</h3>
    <h4 *ngIf="client.phoneNumber" class="light-blue">{{ client.phoneNumber }}</h4>
  </div>

  <div class="flex-column client-details-content">
    <div class="flex-row classes-section">
      <h2 class="light-blue">{{ 'CLIENTS.ENROLLMENT' | translate }}</h2>
      <button 
        mat-icon-button 
        (click)="setShowEnrollmentModal()" class="add-client-button">
        <mat-icon class="add-icon" matPrefix>{{ 'add'}}</mat-icon>
      </button>
    </div>

    <!-- Active Classes -->
    <div *ngFor="let classEnrollment of classesGrouped | keyvalue">
      <h3 class="mid-green">{{ 'CLASS_TYPES.' + classEnrollment.key | translate | capitalize }}</h3>
      <hr />
      <div *ngFor="let locationGroup of classEnrollment.value | keyvalue">
        <h4>{{ locationGroup.key }}</h4>
        <ul>
          <li *ngFor="let classAndEnrollment of locationGroup.value">
            <div class="flex-row details-row">
              <a [routerLink]="['/admin/mobile/classes', classAndEnrollment?.class?._id, 'details']">
                <ng-container *ngIf="classAndEnrollment.enrollment.daysOfWeekOverride as override; else defaultDays">
                  <ng-container *ngIf="override.length > 0; else defaultDays">
                    {{ override | weekdays:'/' }}
                  </ng-container>
                </ng-container>
                <ng-template #defaultDays>
                  {{ classAndEnrollment.class.days | weekdays:'/' }}
                </ng-template><sup *ngIf="isPartiallyEnrolled(classAndEnrollment)" class="partial-badge" [attr.title]="'CLASSES.PARTIAL_ENROLLMENT_TITLE' | translate">{{ 'CLASSES.PARTIAL_ENROLLMENT_LETTER' | translate }}</sup> - {{ classAndEnrollment.class.startTime | timeFormat }}
              </a>
              <div class="action-buttons">
                <button
                  *ngIf="canEditClient && classAndEnrollment.enrollment.status === EnrollmentStatus.ACTIVE && !classAndEnrollment.enrollment.endDate"
                  mat-icon-button
                  (click)="setShowUnenrollModal(classAndEnrollment)"
                  class="unenroll-button"
                  type="button">
                  <mat-icon class="icon">person_remove</mat-icon>
                </button>
                <a
                  *ngIf="isAdmin"
                  [routerLink]="['../payments', classAndEnrollment?.enrollment?._id]"
                  class="payment-history-link">
                  <mat-icon class="icon">receipt_long</mat-icon>
                </a>
              </div>
            </div>
          </li>
        </ul>
      </div>
    </div>

    <div *ngIf="activeClassEnrollmentInfo.length === 0">
      <p class="not-enrolled">{{ 'ENROLLMENTS.NOT_ENROLLED' | translate }}</p>
    </div>

    <!-- Notes Section -->
    <app-notes
      [resourceType]="'client'"
      [resourceId]="clientId || ''"
      [notes]="client?.notes"
      (notesUpdated)="onNotesUpdated($event)">
    </app-notes>

    <!-- Unenrolled Classes -->
    <div *ngIf="unenrolledClassEnrollmentInfo.length > 0" class="unenrolled-section">
      <h3 class="unenrolled-header">{{ 'CLASSES.UNENROLLED_CLASSES' | translate }}</h3>
      <hr />
      <div *ngFor="let classEnrollment of unenrolledClassesGrouped | keyvalue">
        <h3 class="mid-green">{{ 'CLASS_TYPES.' + classEnrollment.key | translate | capitalize }}</h3>
        <div *ngFor="let locationGroup of classEnrollment.value | keyvalue">
          <h4>{{ locationGroup.key }}</h4>
          <ul>
            <li *ngFor="let classAndEnrollment of locationGroup.value">
              <div class="flex-row details-row">
                <a [routerLink]="['/admin/mobile/classes', classAndEnrollment?.class?._id, 'details']">
                  <ng-container *ngIf="classAndEnrollment.enrollment.daysOfWeekOverride as override; else defaultDays">
                    <ng-container *ngIf="override.length > 0; else defaultDays">
                      {{ override | weekdays:'/' }}
                    </ng-container>
                  </ng-container>
                  <ng-template #defaultDays>
                    {{ classAndEnrollment.class.days | weekdays:'/' }}
                  </ng-template><sup *ngIf="isPartiallyEnrolled(classAndEnrollment)" class="partial-badge" [attr.title]="'CLASSES.PARTIAL_ENROLLMENT_TITLE' | translate">{{ 'CLASSES.PARTIAL_ENROLLMENT_LETTER' | translate }}</sup> - {{ classAndEnrollment.class.startTime | timeFormat }}
                </a>
                <a
                  *ngIf="isAdmin"
                  [routerLink]="['../payments', classAndEnrollment?.enrollment?._id]"
                  class="payment-history-link">
                  <mat-icon class="icon">receipt_long</mat-icon>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Terminated Classes -->
    <div *ngIf="terminatedClassEnrollmentInfo.length > 0" class="terminated-section">
      <h3 class="terminated-header">{{ 'CLASSES.TERMINATED_CLASSES' | translate }}</h3>
      <hr />
      <div *ngFor="let classEnrollment of terminatedClassesGrouped | keyvalue">
        <h3 class="mid-green">{{ 'CLASS_TYPES.' + classEnrollment.key | translate | capitalize }}</h3>
        <div *ngFor="let locationGroup of classEnrollment.value | keyvalue">
          <h4>{{ locationGroup.key }}</h4>
          <ul>
            <li *ngFor="let classAndEnrollment of locationGroup.value">
              <div class="flex-row details-row">
                <a [routerLink]="['/admin/mobile/classes', classAndEnrollment?.class?._id, 'details']">
                  <ng-container *ngIf="classAndEnrollment.enrollment.daysOfWeekOverride as override; else defaultDays">
                    <ng-container *ngIf="override.length > 0; else defaultDays">
                      {{ override | weekdays:'/' }}
                    </ng-container>
                  </ng-container>
                  <ng-template #defaultDays>
                    {{ classAndEnrollment.class.days | weekdays:'/' }}
                  </ng-template><sup *ngIf="isPartiallyEnrolled(classAndEnrollment)" class="partial-badge" [attr.title]="'CLASSES.PARTIAL_ENROLLMENT_TITLE' | translate">{{ 'CLASSES.PARTIAL_ENROLLMENT_LETTER' | translate }}</sup> - {{ classAndEnrollment.class.startTime | timeFormat }}
                </a>
                <a
                  *ngIf="isAdmin"
                  [routerLink]="['../payments', classAndEnrollment?.enrollment?._id]"
                  class="payment-history-link">
                  <mat-icon class="icon">receipt_long</mat-icon>
                </a>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Delete User (admin only, enabled when no enrollments, no unpaid invoices, not on waitlist) -->
    <div *ngIf="isAdmin" class="delete-user-section">
      <div class="flex-row buttons">
        <app-button
          [label]="'CLIENTS.DELETE_USER'"
          [disabled]="!canDeleteUser"
          (onClick)="openDeleteUserModal()">
        </app-button>
      </div>
    </div>
  </div>
</div>

<app-modal *ngIf="showEnrollmentModal"
  [parent]="this"
  [title]="'CLIENTS.ENROLL' | translate"
  [buttonList]="enrollmentButtons"
  (modalClick)="processEnrollmentModalClick($event)"
  class="enrollment-modal">
  <div content> 
    <p>{{ 'CLIENTS.ENROLL_INSTRUCTIONS' | translate }}</p>
    <h5>{{ client?.firstName }} {{ client?.lastName }}</h5>

    <form [formGroup]="classSelectionForm">
      <app-dropdown *ngIf="classTypeOptions.length" 
        label="CONTROLS.CLASS_TYPE" 
        [options]="classTypeOptions" 
        [i18nPrefix]="'CLASS_TYPES'"
        controlName="class_type">
      </app-dropdown>
      <app-dropdown 
        label="CONTROLS.LOCATION" 
        [options]="classLocationOptions" 
        controlName="location"
        [disabled]="!selectedType">
      </app-dropdown>
      <app-dropdown
        label="CONTROLS.TIME" 
        [options]="classTimesOptions" 
        controlName="time"
        [disabled]="!selectedType || !selectedLocation">
      </app-dropdown>
      <app-datepicker
        label="CONTROLS.START_DATE"
        controlName="start_date">
      </app-datepicker>

      <mat-expansion-panel [disabled]="!selectedClassId" (opened)="onAdvancedOptionsOpened()">
        <mat-expansion-panel-header>
          {{ 'ENROLLMENTS.ADVANCED_OPTIONS' | translate }}
        </mat-expansion-panel-header>

        <ng-template matExpansionPanelContent>
          <app-multi-select-chips
            *ngIf="advancedOptionsClassInfo && advancedOptionsClassInfo.days.length > 1"
            label="CONTROLS.DAYS_OVERRIDE"
            [options]="weekdays"
            [disabledChipsIndices]="disabledDaysChips"
            i18nPrefix="WEEKDAYS_SHORT"
            controlName="days_override">
          </app-multi-select-chips>
          <app-dropdown
            label="CONTROLS.BILLING_FREQUENCY_OVERRIDE"
            [options]="billingFrequencyOptions"
            controlName="billing_frequency_override"
            [i18nPrefix]="'BILLING_FREQUENCY'"
            [hasNoSelectOption]="true"
            class="billing-frequency">
          </app-dropdown>
        </ng-template>
      </mat-expansion-panel>
    </form>
  </div>
</app-modal>

<app-modal *ngIf="showUnenrollModal"
  [parent]="this"
  [title]="'CLIENTS.UNENROLL' | translate"
  [buttonList]="unenrollButtons"
  (modalClick)="processUnenrollModalClick($event)"
  class="unenroll-modal">
  <div content>
    <p>{{ 'CLIENTS.UNENROLL_CONFIRM_MESSAGE' | translate }}</p>
    <div *ngIf="selectedEnrollmentForUnenroll">
      <h5>
        {{ 'CLASS_TYPES.' + selectedEnrollmentForUnenroll.class.classType | translate | capitalize }} - 
        {{ selectedEnrollmentForUnenroll.class.classLocation }}
      </h5>
      <h5>
        <ng-container *ngIf="selectedEnrollmentForUnenroll.enrollment.daysOfWeekOverride as override; else defaultDays">
          <ng-container *ngIf="override.length > 0; else defaultDays">
            {{ override | weekdays:'/' }}
          </ng-container>
        </ng-container>
        <ng-template #defaultDays>
          {{ selectedEnrollmentForUnenroll.class.days | weekdays:'/' }}
        </ng-template><sup *ngIf="isPartiallyEnrolled(selectedEnrollmentForUnenroll)" class="partial-badge" [attr.title]="'CLASSES.PARTIAL_ENROLLMENT_TITLE' | translate">{{ 'CLASSES.PARTIAL_ENROLLMENT_LETTER' | translate }}</sup> - {{ selectedEnrollmentForUnenroll.class.startTime | timeFormat }}
      </h5>
    </div>
    <form [formGroup]="unenrollForm">
      <textarea 
        formControlName="cancelReason"
        class="unenroll-reason-textarea"
        placeholder="{{ 'CLIENTS.UNENROLL_REASON' | translate }}"
        rows="4">
      </textarea>
    </form>
  </div>
</app-modal>

<app-modal *ngIf="showDeleteUserModal"
  [parent]="this"
  [title]="'CLIENTS.DELETE_USER' | translate"
  [buttonList]="deleteUserButtons"
  (modalClick)="processDeleteUserModalClick($event)"
  class="delete-user-modal">
  <div content>
    <p>{{ 'CLIENTS.DELETE_USER_CONFIRM_MESSAGE' | translate }}</p>
  </div>
</app-modal>
