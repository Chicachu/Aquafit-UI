<div *ngIf="classDetails">
  <app-breadcrumb-nav-bar 
    [title]="'CLASSES.CLASS_DETAILS'" 
    [buttonType]="canEditClass ? ButtonType.EDIT : ButtonType.NONE"
    (onButtonClick)="editClass()">
  </app-breadcrumb-nav-bar>
  <div class="flex-column general-info">
    <h3 class="mid-green">{{ 'CLASS_TYPES.' + classDetails.classType | translate }}</h3>
    <h3 class="light-blue">{{ classDetails.classLocation }}</h3>
    <h3 class="mid-pink">{{ classDetails.days | weekdays:'/' }} - {{ classDetails.startTime | timeFormat }}</h3>
    <h5 class="light-blue">{{ classDetails.prices[0].amount }} {{ classDetails.prices[0].currency }}</h5>
    <!-- <div class="flex-row prices">
      <h3 *ngFor="let price of classDetails.prices">{{ price.amount }} {{ price.currency }}</h3>
    </div> -->
     <h5 class="light-green" *ngFor="let enrollmentCount of classDetails.enrollmentCounts | keyvalue">
      {{ enrollmentCount.key | weekdays }}: {{ enrollmentCount.value }}/{{ classDetails.maxCapacity }} {{ 'CLASSES.ENROLLED' | translate }}
     </h5>
  </div>

  <!-- Client information -->
  <div class="flex-column class-details-content">
    <div class="flex-row clients-section">
      <h2 class="light-blue">{{ 'CLIENTS.TITLE' | translate }}</h2>
      <button 
        *ngIf="userService.isAdmin && !isTerminated"
        mat-icon-button 
        [disabled]="isClassFull"
        (click)="addClientToClass()" class="add-class-button">
        <mat-icon class="add-icon" matPrefix>{{ 'add' }}</mat-icon>
      </button>
    </div>

    <ng-container *ngFor="let status of visibleStatuses">
      <ng-container *ngIf="(clientsByPaymentStatus.get(status)?.length ?? 0) > 0">
        <div [ngClass]="getStatusSectionClass(status)">
          <h3 [ngClass]="paymentStatusConfig[status]?.headingClass">
            {{ paymentStatusConfig[status]?.titleKey || '' | translate }}
          </h3>
          <div *ngIf="paymentStatusConfig[status]?.iconClass" [ngClass]="paymentStatusConfig[status]?.iconClass"></div>
        </div>
    
        <ul>
          <li *ngFor="let client of clientsByPaymentStatus.get(status)">
            <div class="flex-row details-row">
              <a [routerLink]="['../../../clients', client._id, 'details']">
                <p class="white">
                  {{ client.firstName }} {{ client.lastName }}<sup *ngIf="client.isPartiallyEnrolled" class="partial-badge" [attr.title]="'CLASSES.PARTIAL_ENROLLMENT_TITLE' | translate">{{ 'CLASSES.PARTIAL_ENROLLMENT_LETTER' | translate }}</sup>
                </p>
              </a>
              <a
                *ngIf="userService.isAdmin && client.currentPayment?.enrollmentId"
                [routerLink]="['../../../clients', client._id, 'payments', client.currentPayment.enrollmentId]"
                class="payment-history-link">
                <mat-icon class="icon">receipt_long</mat-icon>
              </a>
            </div>
          </li>
        </ul>
      </ng-container>
    </ng-container>

    <div class="flex-row buttons">
      <app-button 
        *ngIf="userService.isAdmin && !isTerminated"
        [label]="'CLASSES.CANCEL'"
        [loading]="loading"
        [loadingMessage]="'CLASSES.CANCELLING'"
        (onClick)="cancelClass()">
      </app-button>
      <app-button 
        *ngIf="canEditClass && !isTerminated"
        [label]="'CLASSES.TERMINATE'"
        [loading]="loading"
        [loadingMessage]="'CLASSES.TERMINATING'"
        (onClick)=terminateClass()>
      </app-button>
    </div>

    <!-- Notes Section (instructors and admins can add/publish/delete unless class terminated; notes shown desc by date) -->
    <app-notes
      [resourceType]="'class'"
      [resourceId]="classId || ''"
      [notes]="classDetails.notes"
      [readOnly]="isTerminated"
      (notesUpdated)="onNotesUpdated($event)">
    </app-notes>

    <!-- Waitlist Section -->
    <div class="flex-row waitlist-section-header">
      <h2 class="light-blue">{{ 'CLASSES.WAIT_LIST' | translate }}</h2>
      <button 
        *ngIf="canAddToWaitlist"
        mat-icon-button 
        (click)="openWaitlistModal()" 
        class="add-button">
        <mat-icon matPrefix>add</mat-icon>
      </button>
    </div>
    <ul>
      <li *ngFor="let entry of waitlistEntries">
        <a *ngIf="waitlistUsers.get(entry.userId)" [routerLink]="['../../../clients', entry.userId, 'details']" class="white">
          {{ waitlistUsers.get(entry.userId)!.firstName }} {{ waitlistUsers.get(entry.userId)!.lastName }}
        </a>
      </li>
      <li *ngIf="waitlistEntries.length === 0">
        <p class="light-blue">{{ 'CLIENTS.NO_WAITLIST_ENTRIES' | translate }}</p>
      </li>
    </ul>
  </div>
</div>

<app-modal *ngIf="showEnrollmentModal"
  [parent]="this"
  [title]="'CLIENTS.ENROLL' | translate"
  [buttonList]="enrollmentButtons"
  (modalClick)="processEnrollmentModalClick($event)"
  class="enrollment-modal">
  <div content> 
    <p>{{ 'CLIENTS.ENROLL_INSTRUCTIONS' | translate }}</p>
    <h5 *ngIf="classDetails">{{ 'CLASS_TYPES.' + classDetails.classType | translate }} - {{ classDetails.classLocation }} - {{ classDetails.startTime | timeFormat }}</h5>

    <p *ngIf="clientOptions.length === 0" class="no-clients-message">All clients are already enrolled in this class.</p>

    <form [formGroup]="enrollmentForm">
      <app-dropdown 
        *ngIf="clientOptions.length"
        label="CLIENTS.TITLE" 
        [options]="clientOptions" 
        controlName="client">
      </app-dropdown>
      <app-datepicker
        label="CONTROLS.START_DATE"
        controlName="start_date"
        [allowedWeekdays]="classDetails?.days">
      </app-datepicker>

      <mat-expansion-panel 
        [disabled]="!enrollmentForm.get('client')?.value" 
        [expanded]="autoExpandAdvancedOptions && needsPartialEnrollment"
        (opened)="onAdvancedOptionsOpened()">
        <mat-expansion-panel-header>
          {{ 'ENROLLMENTS.ADVANCED_OPTIONS' | translate }}
        </mat-expansion-panel-header>

        <ng-template matExpansionPanelContent>
          <app-multi-select-chips
            *ngIf="advancedOptionsClassInfo && advancedOptionsClassInfo.days.length > 1"
            label="CONTROLS.DAYS_OVERRIDE"
            [options]="needsPartialEnrollment ? availableWeekdayOptions : weekdays"
            [disabledChipsIndices]="disabledDaysChips"
            i18nPrefix="WEEKDAYS_SHORT"
            controlName="days_override">
          </app-multi-select-chips>
          <app-dropdown
            label="CONTROLS.BILLING_FREQUENCY_OVERRIDE"
            [options]="billingFrequencyOptions"
            controlName="billing_frequency_override"
            [i18nPrefix]="'BILLING_FREQUENCY'"
            [hasNoSelectOption]="true"
            class="billing-frequency">
          </app-dropdown>
        </ng-template>
      </mat-expansion-panel>
    </form>
  </div>
</app-modal>

<app-modal *ngIf="showTerminateConfirmationModal"
  [parent]="this"
  [title]="'CLASSES.CONFIRM_TERMINATE_TITLE' | translate"
  [buttonList]="[{text: 'CONTROLS.CANCEL'}, {text: 'CLASSES.CONFIRM_TERMINATE'}]"
  (modalClick)="processTerminateConfirmationModalClick($event)"
  class="terminate-confirmation-modal">
  <div content> 
    <p>{{ 'CLASSES.CONFIRM_TERMINATE_MESSAGE' | translate }}</p>
    <p class="warning-text">{{ 'CLASSES.CONFIRM_TERMINATE_WARNING' | translate }}</p>
    <form [formGroup]="terminateForm">
      <app-datepicker
        label="CONTROLS.END_DATE"
        controlName="end_date"
        [minDate]="minTerminationDate">
      </app-datepicker>
    </form>
  </div>
</app-modal>

<app-modal *ngIf="showCancelConfirmationModal"
  [parent]="this"
  [title]="'CLASSES.CONFIRM_CANCEL_TITLE' | translate"
  [buttonList]="cancelButtons"
  (modalClick)="processCancelConfirmationModalClick($event)"
  class="terminate-confirmation-modal">
  <div content> 
    <p>{{ 'CLASSES.CONFIRM_CANCEL_MESSAGE' | translate }}</p>
    <p class="warning-text">{{ 'CLASSES.CONFIRM_CANCEL_WARNING' | translate }}</p>
    <form [formGroup]="cancelForm">
      <app-datepicker
        label="CONTROLS.END_DATE"
        controlName="cancellation_date"
        [allowedWeekdays]="classDetails?.days"
        [disabledDates]="cancelledDates">
      </app-datepicker>
      <div class="form-field">
        <label class="form-label">{{ 'CLASSES.CANCELLATION_REASON' | translate }}*</label>
        <textarea 
          formControlName="reason"
          class="cancellation-reason-textarea"
          placeholder="{{ 'CLASSES.CANCELLATION_REASON_PLACEHOLDER' | translate }}"
          rows="4">
        </textarea>
        <div *ngIf="cancelForm.get('reason')?.invalid && cancelForm.get('reason')?.touched" class="error-message">
          {{ 'CLASSES.CANCELLATION_REASON_REQUIRED' | translate }}
        </div>
      </div>
    </form>
  </div>
</app-modal>

<app-modal *ngIf="showWaitlistModal"
  [parent]="this"
  [title]="'CLIENTS.ADD_TO_WAITLIST' | translate"
  [buttonList]="waitlistModalButtons"
  (modalClick)="handleWaitlistModalClick($event)"
  class="waitlist-modal">
  <div content>
    <p *ngIf="hasAvailableSpace && classDetails" class="waitlist-warning">
      {{ 'CLIENTS.WAITLIST_SPACE_WARNING' | translate }} {{ getFormattedAvailableDays() }}.
    </p>
    <form [formGroup]="waitlistForm" style="border: none; background: transparent; padding: 0; margin: 0;">
      <app-text-input
        label="CONTROLS.FIRSTNAME"
        controlName="firstName">
      </app-text-input>
      <app-text-input
        label="CONTROLS.LASTNAME"
        controlName="lastName">
      </app-text-input>
      <app-phone-input
        label="CONTROLS.PHONENUMBER"
        controlName="phoneNumber"
        [countryCode]="true"
        [countryCodeControlName]="'countryCode'">
      </app-phone-input>
    </form>
  </div>
</app-modal>

 